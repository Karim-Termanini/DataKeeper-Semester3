@startuml
' Sequence: Spiel starten + Laufzeit mit Facade, GameState und LevelConfig

actor Benutzer as User
participant "main.Game" as Game <<facade>>
participant "main.GameWindow" as Fenster
participant "main.GamePanel" as Panel
participant "inputs.KeyboardInputs" as Inputs
participant "ui.MainMenu" as MainMenu
participant "levels.LevelManager\n<<Singleton>>" as LevelMgr
participant "gameplay.GameState" as State
participant "gameplay.SurvivalTimer" as Timer
participant "levels.SpawnManager" as Spawner
participant "levels.LevelConfig" as Config
participant "entities.Player" as Player
participant "entities.Enemy" as Enemy
participant "levels.Portal" as Portal
participant "audio.SoundManager\n<<Singleton>>" as Audio

== App-Start (Facade) ==
User -> Game: Programm starten
activate Game
Game -> Panel: new GamePanel()
Game -> Fenster: new GameWindow(Panel)
loop Game-Loop
  Game -> Panel: updateGame()
end
deactivate Game

== Menübedienung ==
User -> Inputs: ENTER auf "SPIEL STARTEN"
Inputs -> Panel: handleKeyPressed(VK_ENTER)
Panel -> MainMenu: isStartSelected()
MainMenu --> Panel: ja
Panel -> Panel: startGameFromMenu()
activate Panel

== Spielinitialisierung ==
Panel -> Panel: enemies/characters reset
Panel -> Panel: player = new Player()
Panel -> LevelMgr: setPlayer(player)
Panel -> LevelMgr: restartGame()
activate LevelMgr
LevelMgr -> LevelMgr: currentLevelNumber = 1
LevelMgr -> LevelMgr: initializeLevel(1, player)
LevelMgr -> Config: getDuration()/getSpawnInterval()/isBossLevel()
LevelMgr -> Timer: new SurvivalTimer(duration)
LevelMgr -> Spawner: new SpawnManager(config, player)
LevelMgr -> LevelMgr: portal = new Portal(x,y)
LevelMgr --> Panel: «initialized» (getCurrentConfig)
deactivate LevelMgr

Panel -> LevelMgr: setGameState(PLAYING)
Panel -> LevelMgr: startLevel()
activate LevelMgr
LevelMgr -> Timer: start()
LevelMgr -> Spawner: resumeSpawning()
LevelMgr --> Panel: «started»
deactivate LevelMgr

== Audio & HUD ==
Panel -> Audio: stopMenuMusic()
alt Boss-Level?
  Panel -> Audio: playBossMusic()
else
  Panel -> Audio: playBackgroundMusic()
end
Panel -> Panel: hud = new HUD(player, timer, config, 1)
Panel --> MainMenu: «return»
deactivate Panel

== Laufzeit (PLAYING) ==
Panel -> LevelMgr: getGameState()
LevelMgr --> Panel: State.PLAYING
activate Panel
Panel -> Player: update()
Panel -> Spawner: setActiveEnemyCount(enemies.size)
Panel -> LevelMgr: update()
activate LevelMgr
LevelMgr -> Timer: update()
LevelMgr -> Spawner: update()
LevelMgr -> Portal: update()
deactivate LevelMgr
Panel -> Spawner: drainSpawnedEnemies()
Spawner --> Panel: Enemy*
Panel -> Enemy: update() [für jeden]
Portal -> Player: checkPlayerCollision(player)

alt Boss-Level
  Spawner -> "entities.Boss" as Boss: spawn (einmal)
else Normal-Level
  Spawner -> Enemy: spawn (bis Limit)
end

opt Zustandswechsel
  alt Timer komplett
    LevelMgr -> Spawner: stopSpawning()
    LevelMgr -> Portal: activate()
  else Spieler tot
    Panel -> LevelMgr: setGameState(GAME_OVER)
  else Boss besiegt
    Panel -> LevelMgr: setGameState(VICTORY)
  else Am Portal + E
    Panel -> LevelMgr: setGameState(LEVEL_COMPLETE)
  end
end

@enduml
